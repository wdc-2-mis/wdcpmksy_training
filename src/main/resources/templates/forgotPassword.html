<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
            background-color: #5A8AB7;
        }

        .navbar {
            height: 100px;
        }

        .navbar-brand img {
            height: 100%;
            width: auto;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
        }

        .navbar-brand .d-flex {
            flex-direction: column;
        }

        .navbar-brand span {
            font-size: 14px;
        }

        .navbar .text-left {
            text-align: left;
        }

        .content {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: url('images/login_image.png') no-repeat center center fixed;
            background-size: cover;
            background-position: center center;
        }

        .form-group.mb-3 {
            margin-bottom: 20px;
        }

        .form-group span {
            display: block;
            margin-top: 10px;
            text-align: center;
        }

        .card {
            background-color: rgba(214, 245, 245, 0.7); /* Light cyan with 70% opacity */
            border: none;
            color: black;
            min-height: 400px;
            width: 100%; /* Full width for smaller screens */
            max-width: 600px; /* Increase the maximum width */
            margin: 0 auto; /* Center the card horizontally */
            padding: 20px; /* Optional: Add padding for better spacing */
        }

        header {
            background-color: rgba(214, 245, 245, 0.7); /* Light cyan with 70% opacity, same as card */
        }

        footer {
            background-color: rgba(214, 245, 245, 0.7); /* Light cyan with 70% opacity, same as card */
            padding: 20px;
            text-align: center;
            font-size: 14px;
            color: #6c757d;
            position: relative;
            bottom: 0;
            width: 100%;
            margin-top: auto; /* This will push the footer to the bottom of the page */
        }

        footer a {
            color: #007bff;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="images/ashoka-stambh.jpg" alt="Ashoka Stambh" class="me-2">
                <div class="d-flex flex-column">
                    <span class="font-weight-bold">भूमि संसाधन विभाग</span>
                    <span>DEPARTMENT OF LAND RESOURCES</span>
                    <span>MINISTRY OF RURAL DEVELOPMENT</span>
                </div>
            </a>
            <div class="text-left mx-auto">
                <span class="h4">Learning Management System - WDCPMKSY2.0</span>
            </div>
            	<ul class="navbar-nav ms-auto">
                <li class="nav-item">
				    <a class="btn btn-outline-primary mr-2" th:href="@{/login}">Login</a>
				</li>
				<li class="nav-item">
				    <a class="btn btn-outline-secondary" th:href="@{/register}">Register</a>
				</li>
				</ul>
            <div class="text-right">
                <select id="languageSwitcher" class="form-select form-select-sm" hidden>
                    <option value="en">English</option>
                    <option value="hi">हिन्दी</option>
                </select>
            </div>
        </div>
    </nav>

    <div class="container mt-5 flex-grow-1">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 data-translate="forgot">Forgot Password?</h3>
                    </div>
                    <div class="card-body">
                        <form id="resetPasswordForm">
                            <!-- Step 1: User Verification -->
                            <div id="step1">
                                <div class="form-group">
                                    <label for="email" data-translate="email">Email address:</label>
                                    <input type="email" id="email" name="email" class="form-control" autocomplete="off" oninput="this.value = this.value.toLowerCase();" required>
                                </div>
                                <div class="form-group">
                                    <label for="securityQuestion" data-translate="securityques">Security Question:</label>
                                    <select id="securityQuestion" name="securityQuestion" class="form-control" required>
                                        <option value="" data-translate="selsecurityques">Select Security Question</option>
                                        <option th:each="security : ${securityques}" th:value="${security.security_id}" th:text="${security.security_question}"></option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="securityAnswer" data-translate="answer">Answer:</label>
                                    <input type="text" id="securityAnswer" name="securityAnswer" class="form-control" autocomplete="off" required>
                                </div>
                                <div id="errorMessage" class="alert alert-danger hidden"></div>
                                <button type="button" class="btn btn-primary w-100" id="verifyDetails" data-translate="continue">Continue</button>
                            </div>

                            <!-- Step 2: Change Password -->
                            <div id="step2" class="hidden">
                                <div class="form-group">
                                    <label for="newPassword" data-translate="newpass">New Password:</label>
                                    <input type="password" id="newPassword" name="newPassword" class="form-control" autocomplete="off" required>
                                </div>
                                <div class="form-group">
                                    <label for="confirmPassword" data-translate="confpass">Confirm Password:</label>
                                    <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" autocomplete="off" required>
                                </div>
                                <button type="submit" class="btn btn-success w-100" data-translate="resetpass">Reset Password</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            $("#verifyDetails").click(function () {
                var email = $("#email").val();
                var securityQuestion = $("#securityQuestion").val();
                var securityAnswer = $("#securityAnswer").val();

                if (!email || !securityQuestion || !securityAnswer) {
                    $("#errorMessage").text("Please fill all fields.").removeClass("hidden");
                    return;
                }

                $.ajax({
                    url: "/checkuserdtl",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        email: email,
                        securityQuestion: securityQuestion,
                        securityAnswer: securityAnswer
                    }),
                    success: function (response) {
                        if (response.valid) {
                            $("#step1").hide();
                            $("#step2").removeClass("hidden");
                            $("#errorMessage").addClass("hidden");
                        } else {
                            $("#errorMessage").text("Invalid details. Please try again.").removeClass("hidden");
                        }
                    },
                    error: function () {
                        $("#errorMessage").text("Something went wrong. Please try again later.").removeClass("hidden");
                    }
                });
            });
       
       $("#resetPasswordForm").submit(function(event) {
        event.preventDefault();
        let email = $("#email").val();
        let newPassword = $("#newPassword").val();
        let confirmPassword = $("#confirmPassword").val();

        if (newPassword !== confirmPassword) {
            alert("Passwords do not match!");
            return;
        }

        $.ajax({
            type: "POST",
            url: "/reset-password",
            contentType: "application/json",
            data: JSON.stringify({ email, newPassword }),
            success: function(response) {
                alert("Password updated successfully!");
                window.location.href = "/login";
            },
            error: function(xhr) {
                alert(xhr.responseText);
            }
        });
    });
       
        });
        
        
        
    </script>
    <footer>
    <p>Content Owned by Department of Land Resources, Ministry of Rural Development</p>
    <p>Developed and hosted by National Informatics Centre, Ministry of Electronics & Information Technology, Government of India</p>
    </footer>

<script>
const translations = {
    en: {
     forgot: "Forgot Password?",
     email: "Email address:",
     securityques: "Security Question:",
     selsecurityques: "Select Security Question",
     answer: "Answer:",
     continue: "Continue", 
     newpass: "New Password:", 
     confpass: "Confirm Password:",
     resetpass:"Reset Password"
    },
    hi: {
     forgot: "पासवर्ड भूल गए?",
     email: "ई-मेल एड्रेस",
     securityques: "सुरक्षा प्रश्न:",
     selsecurityques: "सुरक्षा प्रश्न चुनें",
     answer: "उत्तर:",
     continue: "जारी रखना", 
     newpass: "नया पासवर्ड:", 
     confpass: "पासवर्ड की पुष्टि कीजिये:",
     resetpass:"पासवर्ड रीसेट"
    }
};

const switchLanguage = (lang) => {
    document.querySelectorAll('[data-translate]').forEach(element => {
        const key = element.getAttribute('data-translate');
        element.innerText = translations[lang][key];
    });
    document.querySelectorAll('[data-placeholder-en]').forEach(element => { 
        element.placeholder = element.getAttribute(`data-placeholder-${lang}`); 
    });
    sessionStorage.setItem('selectedLanguage', lang);
};

document.getElementById('languageSwitcher').addEventListener('change', (event) => {
    switchLanguage(event.target.value);
});

const savedLanguage = sessionStorage.getItem('selectedLanguage') || 'en'; 
document.getElementById('languageSwitcher').value = savedLanguage; 
switchLanguage(savedLanguage);
</script>
</body>
</html>
